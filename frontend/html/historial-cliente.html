<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Historial por Cliente</title>
    <link rel="stylesheet" href="../css/styles.css">

    <style>
        body {
            background-color: #eef0ff;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .topbar {
            width: 100%;
            background: #1a22ff;
            padding: 15px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 26px;
            font-weight: bold;
        }

        .empresa {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .empresa img {
            width: 40px;
            height: 40px;
        }

        .logout-btn {
            background: white;
            color: #1a22ff;
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        .card {
            width: 55%;
            margin: 50px auto;
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.15);
        }

        h2 {
            text-align: center;
            font-size: 32px;
            color: #001f5b;
            margin-bottom: 35px;
            font-weight: 900;
        }

        label {
            font-weight: bold;
            color: #001f5b;
        }

        select {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 18px;
            border-radius: 8px;
            border: 1px solid #bbb;
            font-size: 15px;
        }

        .btn-primary {
            width: 100%;
            background: #1a22ff;
            color: white;
            padding: 16px;
            border-radius: 15px;
            border: none;
            font-size: 20px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background: #001bb8;
        }

        table {
            width: 100%;
            margin-top: 25px;
            border-collapse: collapse;
        }

        th, td {
            border-bottom: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #1a22ff;
            color: white;
        }

        .volver {
            text-align: center;
            margin-top: 20px;
        }

        .volver a {
            color: #001f5b;
            font-weight: bold;
            text-decoration: none;
        }

        .logo-bottom {
            position: fixed;
            bottom: 15px;
            right: 20px;
            width: 120px;
            opacity: 0.25;
        }
    </style>
</head>

<body>

    <div class="topbar">
        <div class="empresa">
            <span>TRANSPORTES SEPÚLVEDA</span>
            <img src="../img/chile.png" alt="Bandera Chile">
        </div>

        <button class="logout-btn" onclick="location.href='login.html'">Cerrar Sesión</button>
    </div>

    <div class="card">
        <h2>Historial por Cliente</h2>

        <label for="cliente">Seleccionar Cliente</label>
        <select id="cliente">
            <option value="">Seleccione un cliente</option>
        </select>

        <button class="btn-primary" onclick="cargarHistorialCliente()">Buscar Historial</button>

        <table id="tablaCliente">
            <thead>
                <tr>
                    <th>ID Viaje</th>
                    <th>Fecha</th>
                    <th>Origen</th>
                    <th>Destino</th>
                    <th>Camión</th>
                    <th>Conductor</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="7">Seleccione un cliente para ver el historial.</td></tr>
            </tbody>
        </table>

        <div class="volver">
            <a href="operaciones.html">← Volver</a>
        </div>
    </div>

    <img src="../img/camion.png" class="logo-bottom">

    <script>
        // =====================================================
        // FORMATEAR FECHA IGUAL QUE EN HISTORIAL DE CAMIÓN
        // =====================================================
        function formatFecha(fecha) {
            if (!fecha) return "—";
            try {
                return new Date(fecha).toISOString().slice(0, 10);
            } catch {
                return "—";
            }
        }

        // =====================================================
        // CARGAR CLIENTES
        // =====================================================
        async function cargarClientes() {
            try {
                const token = localStorage.getItem("token");

                const res = await fetch("/clientes", {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                const data = await res.json();

                const select = document.getElementById("cliente");
                data.forEach(c => {
                    const option = document.createElement("option");
                    option.value = c.id;
                    option.textContent = c.nombre;  // ← Aquí ya no aparece undefined
                    select.appendChild(option);
                });


            } catch (error) {
                console.error("Error cargando clientes:", error);
                alert("No se pudieron cargar los clientes.");
            }
        }

        // =====================================================
        // CARGAR HISTORIAL DEL CLIENTE
        // =====================================================
        async function cargarHistorialCliente() {
            const id = document.getElementById("cliente").value;
            if (!id) return alert("Seleccione un cliente.");

            try {
                const token = localStorage.getItem("token");

                const res = await fetch(`/viajes/cliente/${id}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                const data = await res.json();
                const tbody = document.querySelector("#tablaCliente tbody");
                tbody.innerHTML = "";

                if (!Array.isArray(data) || data.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='7'>No hay viajes registrados para este cliente.</td></tr>";
                    return;
                }

                data.forEach(v => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${v.id}</td>
                            <td>${formatFecha(v.fecha)}</td>
                            <td>${v.origen}</td>
                            <td>${v.destino}</td>
                            <td>${v.camion}</td>
                            <td>${v.conductor}</td>
                            <td>${v.estado}</td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error("Error cargando historial cliente:", error);
                alert("No se pudo cargar el historial.");
            }
        }

        cargarClientes();
    </script>

</body>
</html>
